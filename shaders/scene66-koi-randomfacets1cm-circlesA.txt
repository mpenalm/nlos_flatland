#include "trace-frag"

#include "bsdf"
#include "intersect"

void intersect(Ray ray, inout Intersection isect) {
    bboxIntersect(ray, vec2(0.0), vec2(1.79, 1.0), 5.0, isect);
    lineIntersect(ray, vec2(1.2, -1.0), vec2(1.2, -0.2), 1.0, isect);

    // First hidden wall
lineIntersect(ray, vec2(0.39954, 0.09835), vec2(0.40046, 0.10831), 0.0, isect);
lineIntersect(ray, vec2(0.39659, 0.10634), vec2(0.40341, 0.11366), 0.0, isect);
lineIntersect(ray, vec2(0.40374, 0.11334), vec2(0.39626, 0.11999), 0.0, isect);
lineIntersect(ray, vec2(0.40267, 0.11911), vec2(0.39733, 0.12756), 0.0, isect);
lineIntersect(ray, vec2(0.40287, 0.12591), vec2(0.39713, 0.13409), 0.0, isect);
lineIntersect(ray, vec2(0.40051, 0.13169), vec2(0.39949, 0.14164), 0.0, isect);
lineIntersect(ray, vec2(0.39605, 0.14026), vec2(0.40395, 0.14640), 0.0, isect);
lineIntersect(ray, vec2(0.40006, 0.14500), vec2(0.39994, 0.15500), 0.0, isect);
lineIntersect(ray, vec2(0.39801, 0.15208), vec2(0.40200, 0.16125), 0.0, isect);
lineIntersect(ray, vec2(0.40378, 0.16006), vec2(0.39622, 0.16661), 0.0, isect);
lineIntersect(ray, vec2(0.40222, 0.16552), vec2(0.39778, 0.17448), 0.0, isect);
lineIntersect(ray, vec2(0.39591, 0.17379), vec2(0.40409, 0.17954), 0.0, isect);
lineIntersect(ray, vec2(0.39685, 0.17945), vec2(0.40315, 0.18721), 0.0, isect);
lineIntersect(ray, vec2(0.39988, 0.18500), vec2(0.40012, 0.19500), 0.0, isect);
lineIntersect(ray, vec2(0.40395, 0.19360), vec2(0.39605, 0.19974), 0.0, isect);
lineIntersect(ray, vec2(0.40114, 0.19847), vec2(0.39886, 0.20820), 0.0, isect);
lineIntersect(ray, vec2(0.39583, 0.20724), vec2(0.40417, 0.21276), 0.0, isect);
lineIntersect(ray, vec2(0.40243, 0.21230), vec2(0.39757, 0.22103), 0.0, isect);
lineIntersect(ray, vec2(0.39948, 0.21836), vec2(0.40052, 0.22831), 0.0, isect);
lineIntersect(ray, vec2(0.39883, 0.22514), vec2(0.40117, 0.23486), 0.0, isect);
lineIntersect(ray, vec2(0.40179, 0.23200), vec2(0.39821, 0.24133), 0.0, isect);
lineIntersect(ray, vec2(0.39893, 0.23845), vec2(0.40107, 0.24822), 0.0, isect);
lineIntersect(ray, vec2(0.39681, 0.24615), vec2(0.40319, 0.25385), 0.0, isect);
lineIntersect(ray, vec2(0.39983, 0.25167), vec2(0.40017, 0.26166), 0.0, isect);
lineIntersect(ray, vec2(0.40408, 0.26045), vec2(0.39592, 0.26622), 0.0, isect);
lineIntersect(ray, vec2(0.39984, 0.26500), vec2(0.40016, 0.27500), 0.0, isect);
lineIntersect(ray, vec2(0.40410, 0.27381), vec2(0.39590, 0.27952), 0.0, isect);
lineIntersect(ray, vec2(0.39785, 0.27882), vec2(0.40215, 0.28785), 0.0, isect);
lineIntersect(ray, vec2(0.39875, 0.28516), vec2(0.40125, 0.29484), 0.0, isect);
lineIntersect(ray, vec2(0.39595, 0.29374), vec2(0.40405, 0.29960), 0.0, isect);
lineIntersect(ray, vec2(0.39865, 0.29852), vec2(0.40135, 0.30815), 0.0, isect);
lineIntersect(ray, vec2(0.40001, 0.30500), vec2(0.39999, 0.31500), 0.0, isect);
lineIntersect(ray, vec2(0.40053, 0.31169), vec2(0.39947, 0.32164), 0.0, isect);
lineIntersect(ray, vec2(0.40352, 0.31979), vec2(0.39648, 0.32688), 0.0, isect);
lineIntersect(ray, vec2(0.39834, 0.32528), vec2(0.40166, 0.33472), 0.0, isect);
lineIntersect(ray, vec2(0.39570, 0.33411), vec2(0.40430, 0.33922), 0.0, isect);
lineIntersect(ray, vec2(0.39639, 0.33987), vec2(0.40361, 0.34680), 0.0, isect);
lineIntersect(ray, vec2(0.39874, 0.34516), vec2(0.40126, 0.35484), 0.0, isect);
lineIntersect(ray, vec2(0.40143, 0.35188), vec2(0.39857, 0.36146), 0.0, isect);
lineIntersect(ray, vec2(0.39595, 0.36040), vec2(0.40405, 0.36627), 0.0, isect);
lineIntersect(ray, vec2(0.39580, 0.36729), vec2(0.40420, 0.37271), 0.0, isect);
lineIntersect(ray, vec2(0.39776, 0.37219), vec2(0.40224, 0.38114), 0.0, isect);
lineIntersect(ray, vec2(0.40009, 0.37833), vec2(0.39991, 0.38833), 0.0, isect);
lineIntersect(ray, vec2(0.40034, 0.38501), vec2(0.39966, 0.39499), 0.0, isect);
lineIntersect(ray, vec2(0.39855, 0.39188), vec2(0.40145, 0.40145), 0.0, isect);
lineIntersect(ray, vec2(0.40228, 0.39888), vec2(0.39772, 0.40778), 0.0, isect);
lineIntersect(ray, vec2(0.39733, 0.40577), vec2(0.40267, 0.41423), 0.0, isect);
lineIntersect(ray, vec2(0.40388, 0.41352), vec2(0.39612, 0.41982), 0.0, isect);
lineIntersect(ray, vec2(0.39886, 0.41846), vec2(0.40114, 0.42820), 0.0, isect);
lineIntersect(ray, vec2(0.40147, 0.42522), vec2(0.39853, 0.43478), 0.0, isect);
lineIntersect(ray, vec2(0.39910, 0.43175), vec2(0.40090, 0.44158), 0.0, isect);
lineIntersect(ray, vec2(0.40367, 0.43993), vec2(0.39633, 0.44673), 0.0, isect);
lineIntersect(ray, vec2(0.40274, 0.44581), vec2(0.39726, 0.45419), 0.0, isect);
lineIntersect(ray, vec2(0.40161, 0.45193), vec2(0.39839, 0.46140), 0.0, isect);
lineIntersect(ray, vec2(0.40031, 0.45834), vec2(0.39969, 0.46832), 0.0, isect);
lineIntersect(ray, vec2(0.40281, 0.46587), vec2(0.39719, 0.47413), 0.0, isect);
lineIntersect(ray, vec2(0.40018, 0.47167), vec2(0.39982, 0.48166), 0.0, isect);
lineIntersect(ray, vec2(0.40401, 0.48034), vec2(0.39599, 0.48632), 0.0, isect);
lineIntersect(ray, vec2(0.39907, 0.48509), vec2(0.40093, 0.49491), 0.0, isect);
lineIntersect(ray, vec2(0.40006, 0.49167), vec2(0.39994, 0.50167), 0.0, isect);
lineIntersect(ray, vec2(0.39697, 0.49936), vec2(0.40303, 0.50731), 0.0, isect);
lineIntersect(ray, vec2(0.39677, 0.50619), vec2(0.40323, 0.51381), 0.0, isect);
lineIntersect(ray, vec2(0.40364, 0.51324), vec2(0.39636, 0.52009), 0.0, isect);
lineIntersect(ray, vec2(0.39815, 0.51869), vec2(0.40185, 0.52798), 0.0, isect);
lineIntersect(ray, vec2(0.40200, 0.52542), vec2(0.39800, 0.53458), 0.0, isect);
lineIntersect(ray, vec2(0.39704, 0.53263), vec2(0.40296, 0.54070), 0.0, isect);
lineIntersect(ray, vec2(0.39652, 0.53974), vec2(0.40348, 0.54692), 0.0, isect);
lineIntersect(ray, vec2(0.39589, 0.54715), vec2(0.40411, 0.55285), 0.0, isect);
lineIntersect(ray, vec2(0.40391, 0.55355), vec2(0.39609, 0.55979), 0.0, isect);
lineIntersect(ray, vec2(0.40317, 0.55946), vec2(0.39683, 0.56720), 0.0, isect);
lineIntersect(ray, vec2(0.39864, 0.56519), vec2(0.40136, 0.57481), 0.0, isect);
lineIntersect(ray, vec2(0.39967, 0.57168), vec2(0.40033, 0.58166), 0.0, isect);
lineIntersect(ray, vec2(0.39587, 0.58052), vec2(0.40413, 0.58615), 0.0, isect);
lineIntersect(ray, vec2(0.40326, 0.58621), vec2(0.39674, 0.59379), 0.0, isect);
lineIntersect(ray, vec2(0.39899, 0.59177), vec2(0.40101, 0.60156), 0.0, isect);
lineIntersect(ray, vec2(0.40233, 0.59891), vec2(0.39767, 0.60776), 0.0, isect);
lineIntersect(ray, vec2(0.40162, 0.60527), vec2(0.39838, 0.61473), 0.0, isect);
lineIntersect(ray, vec2(0.40364, 0.61324), vec2(0.39636, 0.62009), 0.0, isect);
lineIntersect(ray, vec2(0.39582, 0.62059), vec2(0.40418, 0.62608), 0.0, isect);
lineIntersect(ray, vec2(0.40333, 0.62627), vec2(0.39667, 0.63373), 0.0, isect);
lineIntersect(ray, vec2(0.40219, 0.63217), vec2(0.39781, 0.64116), 0.0, isect);
lineIntersect(ray, vec2(0.39589, 0.64049), vec2(0.40411, 0.64618), 0.0, isect);
lineIntersect(ray, vec2(0.39978, 0.64500), vec2(0.40022, 0.65500), 0.0, isect);
lineIntersect(ray, vec2(0.39642, 0.65318), vec2(0.40358, 0.66016), 0.0, isect);
lineIntersect(ray, vec2(0.39931, 0.65838), vec2(0.40069, 0.66828), 0.0, isect);
lineIntersect(ray, vec2(0.39629, 0.66665), vec2(0.40371, 0.67335), 0.0, isect);
lineIntersect(ray, vec2(0.39733, 0.67244), vec2(0.40267, 0.68090), 0.0, isect);
lineIntersect(ray, vec2(0.40378, 0.68006), vec2(0.39622, 0.68660), 0.0, isect);
lineIntersect(ray, vec2(0.39975, 0.68501), vec2(0.40025, 0.69499), 0.0, isect);
lineIntersect(ray, vec2(0.40298, 0.69265), vec2(0.39702, 0.70068), 0.0, isect);
lineIntersect(ray, vec2(0.40279, 0.69918), vec2(0.39721, 0.70749), 0.0, isect);
lineIntersect(ray, vec2(0.40056, 0.70503), vec2(0.39944, 0.71497), 0.0, isect);
lineIntersect(ray, vec2(0.39662, 0.71298), vec2(0.40338, 0.72035), 0.0, isect);
lineIntersect(ray, vec2(0.39686, 0.71945), vec2(0.40314, 0.72722), 0.0, isect);
lineIntersect(ray, vec2(0.40304, 0.72603), vec2(0.39696, 0.73397), 0.0, isect);
lineIntersect(ray, vec2(0.39951, 0.73169), vec2(0.40049, 0.74164), 0.0, isect);
lineIntersect(ray, vec2(0.40302, 0.73935), vec2(0.39698, 0.74732), 0.0, isect);
lineIntersect(ray, vec2(0.40091, 0.74508), vec2(0.39909, 0.75492), 0.0, isect);
lineIntersect(ray, vec2(0.40018, 0.75167), vec2(0.39982, 0.76166), 0.0, isect);
lineIntersect(ray, vec2(0.39577, 0.76067), vec2(0.40423, 0.76599), 0.0, isect);
lineIntersect(ray, vec2(0.39696, 0.76603), vec2(0.40304, 0.77397), 0.0, isect);
lineIntersect(ray, vec2(0.40406, 0.77375), vec2(0.39594, 0.77958), 0.0, isect);
lineIntersect(ray, vec2(0.40425, 0.78070), vec2(0.39575, 0.78596), 0.0, isect);
lineIntersect(ray, vec2(0.40154, 0.78524), vec2(0.39846, 0.79476), 0.0, isect);
lineIntersect(ray, vec2(0.39811, 0.79204), vec2(0.40189, 0.80130), 0.0, isect);
lineIntersect(ray, vec2(0.39697, 0.79936), vec2(0.40303, 0.80731), 0.0, isect);
lineIntersect(ray, vec2(0.40238, 0.80560), vec2(0.39762, 0.81440), 0.0, isect);
lineIntersect(ray, vec2(0.39660, 0.81300), vec2(0.40340, 0.82034), 0.0, isect);
lineIntersect(ray, vec2(0.40234, 0.81892), vec2(0.39766, 0.82775), 0.0, isect);
lineIntersect(ray, vec2(0.40310, 0.82608), vec2(0.39690, 0.83392), 0.0, isect);
lineIntersect(ray, vec2(0.40264, 0.83242), vec2(0.39736, 0.84091), 0.0, isect);
lineIntersect(ray, vec2(0.39728, 0.83914), vec2(0.40272, 0.84753), 0.0, isect);
lineIntersect(ray, vec2(0.39982, 0.84500), vec2(0.40018, 0.85500), 0.0, isect);
lineIntersect(ray, vec2(0.39845, 0.85191), vec2(0.40155, 0.86142), 0.0, isect);
lineIntersect(ray, vec2(0.39719, 0.85920), vec2(0.40281, 0.86747), 0.0, isect);
lineIntersect(ray, vec2(0.39589, 0.86715), vec2(0.40411, 0.87285), 0.0, isect);
lineIntersect(ray, vec2(0.40396, 0.87361), vec2(0.39604, 0.87972), 0.0, isect);
lineIntersect(ray, vec2(0.40279, 0.87918), vec2(0.39721, 0.88748), 0.0, isect);
lineIntersect(ray, vec2(0.39625, 0.88670), vec2(0.40375, 0.89330), 0.0, isect);
lineIntersect(ray, vec2(0.40382, 0.89344), vec2(0.39618, 0.89990), 0.0, isect);

    // Second hidden wall
    circleIntersect(ray, vec2(1.2, 0.7), 0.05, 0.0, isect);
    circleIntersect(ray, vec2(1.2, 0.3), 0.05, 0.0, isect);

    // Occluder
    bboxIntersect(ray, vec2(1.2, 0.0), vec2(0.1, 0.05), 5.0, isect);
}

vec2 sample(inout vec4 state, Intersection isect, float lambda, vec2 wiLocal, inout vec3 throughput, out float tMult) {
    tMult = 1.0;
    if (isect.mat == 5.0) {
        // Bounding box
        throughput = vec3(0.0);
        return sampleDiffuse(state, wiLocal);
    } else if (isect.mat == 1.0) {
        // Relay wall
        throughput *= vec3(0.5);
        return sampleDiffuse(state, wiLocal);
    } else {
        throughput *= vec3(0.5);
        return sampleDiffuse(state, wiLocal);
    }
}
