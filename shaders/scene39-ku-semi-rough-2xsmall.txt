#include "trace-frag"

#include "bsdf"
#include "intersect"

void intersect(Ray ray, inout Intersection isect) {
    bboxIntersect(ray, vec2(0.0), vec2(1.79, 1.0), 3.0, isect);

    // relay wall
    lineIntersect(ray, vec2(1.2, -1.0), vec2(1.2, -0.2), 0.0, isect);

    // first hidden wall (mirror wall)
    lineIntersect(ray, vec2(0.405, -0.4), vec2(0.395, -0.39), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.39), vec2(0.405, -0.38), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.38), vec2(0.395, -0.37), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.37), vec2(0.405, -0.36), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.36), vec2(0.395, -0.35), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.35), vec2(0.405, -0.33999999999999997), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.33999999999999997), vec2(0.395, -0.32999999999999996), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.32999999999999996), vec2(0.405, -0.31999999999999995), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.31999999999999995), vec2(0.395, -0.30999999999999994), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.30999999999999994), vec2(0.405, -0.29999999999999993), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.29999999999999993), vec2(0.395, -0.2899999999999999), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.2899999999999999), vec2(0.405, -0.2799999999999999), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.2799999999999999), vec2(0.395, -0.2699999999999999), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.2699999999999999), vec2(0.405, -0.2599999999999999), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.2599999999999999), vec2(0.395, -0.2499999999999999), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.2499999999999999), vec2(0.405, -0.23999999999999988), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.23999999999999988), vec2(0.395, -0.22999999999999987), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.22999999999999987), vec2(0.405, -0.21999999999999986), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.21999999999999986), vec2(0.395, -0.20999999999999985), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.20999999999999985), vec2(0.405, -0.19999999999999984), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.19999999999999984), vec2(0.395, -0.18999999999999984), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.18999999999999984), vec2(0.405, -0.17999999999999983), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.17999999999999983), vec2(0.395, -0.16999999999999982), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.16999999999999982), vec2(0.405, -0.1599999999999998), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.1599999999999998), vec2(0.395, -0.1499999999999998), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.1499999999999998), vec2(0.405, -0.1399999999999998), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.1399999999999998), vec2(0.395, -0.12999999999999978), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.12999999999999978), vec2(0.405, -0.11999999999999979), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.11999999999999979), vec2(0.395, -0.10999999999999979), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.10999999999999979), vec2(0.405, -0.0999999999999998), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.0999999999999998), vec2(0.395, -0.0899999999999998), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.0899999999999998), vec2(0.405, -0.07999999999999981), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.07999999999999981), vec2(0.395, -0.06999999999999981), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.06999999999999981), vec2(0.405, -0.05999999999999981), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.05999999999999981), vec2(0.395, -0.04999999999999981), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.04999999999999981), vec2(0.405, -0.03999999999999981), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.03999999999999981), vec2(0.395, -0.029999999999999805), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.029999999999999805), vec2(0.405, -0.019999999999999803), 0.0, isect);
    lineIntersect(ray, vec2(0.405, -0.019999999999999803), vec2(0.395, -0.009999999999999802), 0.0, isect);
    lineIntersect(ray, vec2(0.395, -0.009999999999999802), vec2(0.405, 0.0), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.0), vec2(0.395, 0.010000000000000198), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.010000000000000198), vec2(0.405, 0.020000000000000198), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.020000000000000198), vec2(0.395, 0.0300000000000002), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.0300000000000002), vec2(0.405, 0.0400000000000002), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.0400000000000002), vec2(0.395, 0.050000000000000204), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.050000000000000204), vec2(0.405, 0.060000000000000206), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.060000000000000206), vec2(0.395, 0.0700000000000002), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.0700000000000002), vec2(0.405, 0.0800000000000002), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.0800000000000002), vec2(0.395, 0.09000000000000019), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.09000000000000019), vec2(0.405, 0.10000000000000019), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.10000000000000019), vec2(0.395, 0.11000000000000018), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.11000000000000018), vec2(0.405, 0.12000000000000018), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.12000000000000018), vec2(0.395, 0.13000000000000017), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.13000000000000017), vec2(0.405, 0.14000000000000018), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.14000000000000018), vec2(0.395, 0.1500000000000002), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.1500000000000002), vec2(0.405, 0.1600000000000002), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.1600000000000002), vec2(0.395, 0.1700000000000002), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.1700000000000002), vec2(0.405, 0.18000000000000022), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.18000000000000022), vec2(0.395, 0.19000000000000022), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.19000000000000022), vec2(0.405, 0.20000000000000023), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.20000000000000023), vec2(0.395, 0.21000000000000024), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.21000000000000024), vec2(0.405, 0.22000000000000025), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.22000000000000025), vec2(0.395, 0.23000000000000026), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.23000000000000026), vec2(0.405, 0.24000000000000027), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.24000000000000027), vec2(0.395, 0.2500000000000003), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.2500000000000003), vec2(0.405, 0.2600000000000003), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.2600000000000003), vec2(0.395, 0.2700000000000003), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.2700000000000003), vec2(0.405, 0.2800000000000003), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.2800000000000003), vec2(0.395, 0.2900000000000003), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.2900000000000003), vec2(0.405, 0.3000000000000003), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.3000000000000003), vec2(0.395, 0.31000000000000033), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.31000000000000033), vec2(0.405, 0.32000000000000034), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.32000000000000034), vec2(0.395, 0.33000000000000035), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.33000000000000035), vec2(0.405, 0.34000000000000036), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.34000000000000036), vec2(0.395, 0.35000000000000037), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.35000000000000037), vec2(0.405, 0.3600000000000004), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.3600000000000004), vec2(0.395, 0.3700000000000004), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.3700000000000004), vec2(0.405, 0.3800000000000004), 0.0, isect);
    lineIntersect(ray, vec2(0.405, 0.3800000000000004), vec2(0.395, 0.3900000000000004), 0.0, isect);
    lineIntersect(ray, vec2(0.395, 0.3900000000000004), vec2(0.405, 0.4000000000000004), 0.0, isect);

    // doubly-hidden wall
    lineIntersect(ray, vec2(1.2125, 0.0), vec2(1.1875, 0.025), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.025), vec2(1.2125, 0.05), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.05), vec2(1.1875, 0.07500000000000001), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.07500000000000001), vec2(1.2125, 0.1), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.1), vec2(1.1875, 0.125), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.125), vec2(1.2125, 0.15), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.15), vec2(1.1875, 0.175), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.175), vec2(1.2125, 0.19999999999999998), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.19999999999999998), vec2(1.1875, 0.22499999999999998), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.22499999999999998), vec2(1.2125, 0.24999999999999997), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.24999999999999997), vec2(1.1875, 0.27499999999999997), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.27499999999999997), vec2(1.2125, 0.3), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.3), vec2(1.1875, 0.325), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.325), vec2(1.2125, 0.35000000000000003), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.35000000000000003), vec2(1.1875, 0.37500000000000006), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.37500000000000006), vec2(1.2125, 0.4000000000000001), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.4000000000000001), vec2(1.1875, 0.4250000000000001), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.4250000000000001), vec2(1.2125, 0.4500000000000001), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.4500000000000001), vec2(1.1875, 0.47500000000000014), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.47500000000000014), vec2(1.2125, 0.5000000000000001), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.5000000000000001), vec2(1.1875, 0.5250000000000001), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.5250000000000001), vec2(1.2125, 0.5500000000000002), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.5500000000000002), vec2(1.1875, 0.5750000000000002), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.5750000000000002), vec2(1.2125, 0.6000000000000002), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.6000000000000002), vec2(1.1875, 0.6250000000000002), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.6250000000000002), vec2(1.2125, 0.6500000000000002), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.6500000000000002), vec2(1.1875, 0.6750000000000003), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.6750000000000003), vec2(1.2125, 0.7000000000000003), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.7000000000000003), vec2(1.1875, 0.7250000000000003), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.7250000000000003), vec2(1.2125, 0.7500000000000003), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.7500000000000003), vec2(1.1875, 0.7750000000000004), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.7750000000000004), vec2(1.2125, 0.8000000000000004), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.8000000000000004), vec2(1.1875, 0.8250000000000004), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.8250000000000004), vec2(1.2125, 0.8500000000000004), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.8500000000000004), vec2(1.1875, 0.8750000000000004), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.8750000000000004), vec2(1.2125, 0.9000000000000005), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.9000000000000005), vec2(1.1875, 0.9250000000000005), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.9250000000000005), vec2(1.2125, 0.9500000000000005), 0.0, isect);
    lineIntersect(ray, vec2(1.2125, 0.9500000000000005), vec2(1.1875, 0.9750000000000005), 0.0, isect);
    lineIntersect(ray, vec2(1.1875, 0.9750000000000005), vec2(1.2125, 1.0000000000000004), 0.0, isect);
}

vec2 sample(inout vec4 state, Intersection isect, float lambda, vec2 wiLocal, inout vec3 throughput, out float tMult) {
    tMult = 1.0;
    if (isect.mat == 1.0) {
        return sampleRoughMirror(state, wiLocal, throughput, 0.5);
        float ior = sqrt(sellmeierIor(vec3(1.0396, 0.2318, 1.0105), vec3(0.0060, 0.0200, 103.56), lambda));
        if (wiLocal.y < 0.0) {
            // The ray comes from inside the dielectric material - it will take longer times
            tMult = ior;
        }
        return sampleDielectric(state, wiLocal, ior);
    } else if (isect.mat == 2.0) {
        return sampleMirror(wiLocal);
    } else if (isect.mat == 3.0) {
        throughput *= vec3(0.0);
        return sampleDiffuse(state, wiLocal);
    } else {
        throughput *= vec3(0.5);
        return sampleDiffuse(state, wiLocal);
    }
}