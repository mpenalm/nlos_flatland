#include "preamble"

// our texture
uniform sampler2D u_image;
uniform sampler2D u_kernel;

#define KERNEL_SIZE 4096
#define KERNEL_INTERVAL 1.0 / 4096.0
#define KERNEL_START_IDX 0.5 + KERNEL_INTERVAL / 2.0

varying vec2 mPos; // Pixel coordinates [0,1]

void main() {
	vec4 meanColor = vec4(0);
	for (int i = 0; i < KERNEL_SIZE; i++) {
        float imgIdx = (float(i) + 0.5) * KERNEL_INTERVAL;
		float knlIdx = KERNEL_START_IDX + mPos.x - imgIdx;
		meanColor += texture2D(u_image, vec2(imgIdx, mPos.y)) *
            texture2D(u_kernel, vec2(knlIdx, 0.5)) * vec4(knlIdx > 0.0 && knlIdx < 1.0);
	}
	gl_FragColor = meanColor;
}