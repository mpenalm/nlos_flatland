#include "preamble"

uniform sampler2D radiance; // x time, y spad

uniform int numRows;
uniform int useAbsolute;
uniform vec2 numPixels;

varying vec2 mPos; // Pixel coordinates [0,1]

const int numSpads = {numSpads};

void main() {
    float x = floor(mPos.x * numPixels.x);
    float y = floor(mPos.y * numPixels.y);
    float npy = numPixels.y / float(numRows);
    float yStart = (floor(y / npy) * 2.0 + 1.0) / float(numRows * 2); // 0.5 for single row, for two rows: 0.25 for first, 0.75 for second
    bool isSecond = (y >= npy) && (numRows == 2);
    y = mod(y, npy);
    float pos = x + numPixels.x * (npy - 1.0 - y);
    pos = (pos + 0.5) / (numPixels.x * npy);

    float spadDist = 1.0 / float(numSpads);

    vec2 radianceAccum = vec2(0.0);
    for (int i = 0; i < numSpads; i++) {
        radianceAccum += texture2D(radiance, vec2(pos, spadDist * (float(i) + yStart))).xy;
    }

    //radianceAccum.x = radianceAccum.x * float(1 - useAbsolute) + length(radianceAccum) * float(useAbsolute);
    //radianceAccum.y = radianceAccum.y * float(1 - useAbsolute);
    float result = length(radianceAccum);

    if (useAbsolute > 0) {
        gl_FragColor = vec4(result, 0.0, 0.0, 1.0);
    } else {
        gl_FragColor = vec4(radianceAccum, 0.0, 1.0);
    }
}
