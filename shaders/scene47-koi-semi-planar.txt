#include "trace-frag"

#include "bsdf"
#include "intersect"

void intersect(Ray ray, inout Intersection isect) {
    bboxIntersect(ray, vec2(0.0), vec2(1.79, 1.0), 0.0, isect);
    lineIntersect(ray, vec2(1.2, -1.0), vec2(1.2, -0.2), 1.0, isect);

    // First hidden wall
    lineIntersect(ray, vec2(0.41000000000000003, 0.9), vec2(0.39, 0.88), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.88), vec2(0.41000000000000003, 0.86), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.86), vec2(0.39, 0.84), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.84), vec2(0.41000000000000003, 0.82), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.82), vec2(0.39, 0.7999999999999999), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.7999999999999999), vec2(0.41000000000000003, 0.7799999999999999), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.7799999999999999), vec2(0.39, 0.7599999999999999), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.7599999999999999), vec2(0.41000000000000003, 0.7399999999999999), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.7399999999999999), vec2(0.39, 0.7199999999999999), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.7199999999999999), vec2(0.41000000000000003, 0.6999999999999998), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.6999999999999998), vec2(0.39, 0.6799999999999998), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.6799999999999998), vec2(0.41000000000000003, 0.6599999999999998), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.6599999999999998), vec2(0.39, 0.6399999999999998), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.6399999999999998), vec2(0.41000000000000003, 0.6199999999999998), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.6199999999999998), vec2(0.39, 0.5999999999999998), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.5999999999999998), vec2(0.41000000000000003, 0.5799999999999997), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.5799999999999997), vec2(0.39, 0.5599999999999997), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.5599999999999997), vec2(0.41000000000000003, 0.5399999999999997), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.5399999999999997), vec2(0.39, 0.5199999999999997), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.5199999999999997), vec2(0.41000000000000003, 0.49999999999999967), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.49999999999999967), vec2(0.39, 0.47999999999999965), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.47999999999999965), vec2(0.41000000000000003, 0.45999999999999963), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.45999999999999963), vec2(0.39, 0.4399999999999996), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.4399999999999996), vec2(0.41000000000000003, 0.4199999999999996), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.4199999999999996), vec2(0.39, 0.3999999999999996), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.3999999999999996), vec2(0.41000000000000003, 0.37999999999999956), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.37999999999999956), vec2(0.39, 0.35999999999999954), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.35999999999999954), vec2(0.41000000000000003, 0.3399999999999995), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.3399999999999995), vec2(0.39, 0.3199999999999995), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.3199999999999995), vec2(0.41000000000000003, 0.2999999999999995), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.2999999999999995), vec2(0.39, 0.27999999999999947), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.27999999999999947), vec2(0.41000000000000003, 0.25999999999999945), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.25999999999999945), vec2(0.39, 0.23999999999999946), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.23999999999999946), vec2(0.41000000000000003, 0.21999999999999947), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.21999999999999947), vec2(0.39, 0.19999999999999948), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.19999999999999948), vec2(0.41000000000000003, 0.1799999999999995), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.1799999999999995), vec2(0.39, 0.1599999999999995), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.1599999999999995), vec2(0.41000000000000003, 0.1399999999999995), 2.0, isect);
    lineIntersect(ray, vec2(0.41000000000000003, 0.1399999999999995), vec2(0.39, 0.11999999999999951), 2.0, isect);
    lineIntersect(ray, vec2(0.39, 0.11999999999999951), vec2(0.41000000000000003, 0.0999999999999995), 2.0, isect);

    // Second hidden wall
    lineIntersect(ray, vec2(1.2, 0.1), vec2(1.2, 0.9), 2.0, isect);
}

vec2 sample(inout vec4 state, Intersection isect, float lambda, vec2 wiLocal, inout vec3 throughput, out float tMult) {
    tMult = 1.0;
    if (isect.mat == 0.0) {
        // Bounding box
        throughput = vec3(0.0);
        return sampleDiffuse(state, wiLocal);
    } else if (isect.mat == 1.0) {
        // Relay wall
        throughput *= vec3(0.5);
        return sampleDiffuse(state, wiLocal);
    } else {
        throughput *= vec3(0.5);
        return sampleDiffuse(state, wiLocal);
    }
}
